{% extends 'base.html' %}
{% load static %}

{% block title %}Analysis Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Project Analysis Dashboard</h1>

    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Select Project</h5>
                    <select id="project-selector" class="form-select">
                        <option selected>Choose a project...</option>
                        <!-- Projects will be added here by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Analysis Types</h5>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" data-analysis="deadline-violations">Deadline Violations</a>
                        <a href="#" class="list-group-item list-group-item-action" data-analysis="critical-path">Critical Path</a>
                        <a href="#" class="list-group-item list-group-item-action" data-analysis="resource-allocation">Resource Allocation</a>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Global Analysis</h5>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" data-analysis="early-warnings">Early Warnings</a>
                        <a href="#" class="list-group-item list-group-item-action" data-analysis="historical-patterns">Historical Patterns</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="analysis-title">Select an analysis type</h5>
                    <button id="export-btn" class="btn btn-sm btn-outline-primary" style="display: none;">Export to PDF</button>
                </div>
                <div class="card-body">
                    <div id="loading" style="display: none;">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div id="analysis-content">
                        <p class="text-center text-muted">Please select a project and analysis type from the left panel</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const api = new ApiClient();
    const projectSelector = document.getElementById('project-selector');
    const analysisLinks = document.querySelectorAll('[data-analysis]');
    const analysisTitle = document.getElementById('analysis-title');
    const analysisContent = document.getElementById('analysis-content');
    const loading = document.getElementById('loading');
    const exportBtn = document.getElementById('export-btn');
    
    let currentProjectId = null;
    let currentAnalysisType = null;
    
    // Load projects
    api.getProjects().then(projects => {
        projects.results.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelector.appendChild(option);
        });
    }).catch(error => {
        console.error('Error loading projects:', error);
        analysisContent.innerHTML = `<div class="alert alert-danger">Error loading projects: ${error.message}</div>`;
    });
    
    // Project selection
    projectSelector.addEventListener('change', function() {
        currentProjectId = this.value;
        if (currentAnalysisType && currentProjectId) {
            loadAnalysis(currentAnalysisType, currentProjectId);
        }
    });
    
    // Analysis type selection
    analysisLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            analysisLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            currentAnalysisType = this.getAttribute('data-analysis');
            
            if (currentAnalysisType === 'early-warnings' || currentAnalysisType === 'historical-patterns') {
                loadGlobalAnalysis(currentAnalysisType);
            } else if (currentProjectId) {
                loadAnalysis(currentAnalysisType, currentProjectId);
            } else {
                analysisContent.innerHTML = '<div class="alert alert-warning">Please select a project first</div>';
            }
        });
    });
    
    function loadAnalysis(type, projectId) {
        showLoading();
        let promise;
        
        switch(type) {
            case 'deadline-violations':
                promise = api.getDeadlineViolations(projectId);
                analysisTitle.textContent = 'Deadline Violations Analysis';
                break;
            case 'critical-path':
                promise = api.getCriticalPath(projectId);
                analysisTitle.textContent = 'Critical Path Analysis';
                break;
            case 'resource-allocation':
                promise = api.getResourceAllocation(projectId);
                analysisTitle.textContent = 'Resource Allocation Analysis';
                break;
            default:
                hideLoading();
                analysisContent.innerHTML = '<div class="alert alert-danger">Invalid analysis type</div>';
                return;
        }
        
        promise.then(data => {
            renderAnalysisResult(type, data);
            exportBtn.style.display = 'block';
        }).catch(error => {
            console.error(`Error loading ${type}:`, error);
            analysisContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            exportBtn.style.display = 'none';
        }).finally(() => {
            hideLoading();
        });
    }
    
    function loadGlobalAnalysis(type) {
        showLoading();
        let promise;
        
        switch(type) {
            case 'early-warnings':
                promise = api.getEarlyWarnings();
                analysisTitle.textContent = 'Early Warnings';
                break;
            case 'historical-patterns':
                promise = api.getHistoricalPatterns();
                analysisTitle.textContent = 'Historical Patterns Analysis';
                break;
            default:
                hideLoading();
                analysisContent.innerHTML = '<div class="alert alert-danger">Invalid analysis type</div>';
                return;
        }
        
        promise.then(data => {
            renderAnalysisResult(type, data);
            exportBtn.style.display = 'block';
        }).catch(error => {
            console.error(`Error loading ${type}:`, error);
            analysisContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            exportBtn.style.display = 'none';
        }).finally(() => {
            hideLoading();
        });
    }
    
    function renderAnalysisResult(type, data) {
        let html = '';
        
        switch(type) {
            case 'deadline-violations':
                html = renderDeadlineViolations(data);
                break;
            case 'critical-path':
                html = renderCriticalPath(data);
                break;
            case 'resource-allocation':
                html = renderResourceAllocation(data);
                break;
            case 'early-warnings':
                html = renderEarlyWarnings(data);
                break;
            case 'historical-patterns':
                html = renderHistoricalPatterns(data);
                break;
        }
        
        analysisContent.innerHTML = html;
    }
    
    function renderDeadlineViolations(data) {
        let html = `<h4>${data.project_name}</h4>`;
        
        if (data.is_overdue) {
            html += `<div class="alert alert-danger">This project is currently ${data.days_overdue} days overdue!</div>`;
        }
        
        if (data.suggestions && data.suggestions.length > 0) {
            html += '<div class="card mb-3"><div class="card-header bg-warning text-dark">Suggestions</div><div class="card-body"><ul>';
            data.suggestions.forEach(suggestion => {
                html += `<li>${suggestion}</li>`;
            });
            html += '</ul></div></div>';
        }
        
        if (data.phase_violations && data.phase_violations.length > 0) {
            html += '<h5 class="mt-4">Phase Deadline Violations</h5>';
            html += '<table class="table table-striped"><thead><tr><th>Phase</th><th>Days Late</th><th>Responsible</th></tr></thead><tbody>';
            data.phase_violations.forEach(violation => {
                html += `<tr><td>${violation.phase_name}</td><td>${violation.days_late}</td><td>${violation.responsible}</td></tr>`;
            });
            html += '</tbody></table>';
        }
        
        if (data.output_violations && data.output_violations.length > 0) {
            html += '<h5 class="mt-4">Output Deadline Violations</h5>';
            html += '<table class="table table-striped"><thead><tr><th>Output</th><th>Phase</th><th>Days Late</th><th>Responsible</th></tr></thead><tbody>';
            data.output_violations.forEach(violation => {
                html += `<tr><td>${violation.output_name}</td><td>${violation.phase_name}</td><td>${violation.days_late}</td><td>${violation.responsible}</td></tr>`;
            });
            html += '</tbody></table>';
        }
        
        return html;
    }
    
    function renderCriticalPath(data) {
        // ...rendering code for critical path...
        return `<h4>${data.project_name} - Critical Path Analysis</h4>
                <p>Total delay: ${data.total_delayed_days} days</p>
                <!-- More detailed rendering would go here -->`;
    }
    
    function renderResourceAllocation(data) {
        // ...rendering code for resource allocation...
        return `<h4>${data.project_name} - Resource Allocation Analysis</h4>
                <!-- More detailed rendering would go here -->`;
    }
    
    function renderEarlyWarnings(data) {
        // ...rendering code for early warnings...
        return `<h4>Early Warnings</h4>
                <p>${data.length} potential issues detected</p>
                <!-- More detailed rendering would go here -->`;
    }
    
    function renderHistoricalPatterns(data) {
        // ...rendering code for historical patterns...
        return `<h4>Historical Pattern Analysis</h4>
                <p>Projects analyzed: ${data.total_projects}</p>
                <!-- More detailed rendering would go here -->`;
    }
    
    function showLoading() {
        loading.style.display = 'block';
        analysisContent.style.display = 'none';
    }
    
    function hideLoading() {
        loading.style.display = 'none';
        analysisContent.style.display = 'block';
    }
    
    // Export button (placeholder functionality)
    exportBtn.addEventListener('click', function() {
        alert('Export functionality would go here');
    });
});
</script>
{% endblock %}